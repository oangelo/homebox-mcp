#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: Homebox MCP Server
# Runs the MCP server for Homebox inventory management
# ==============================================================================

bashio::log.info "Starting Homebox MCP Server..."

# Export configuration as environment variables
export HOMEBOX_URL="$(bashio::config 'homebox_url')"
export HOMEBOX_TOKEN="$(bashio::config 'homebox_token')"
export MCP_AUTH_TOKEN="$(bashio::config 'mcp_auth_token')"
export LOG_LEVEL="$(bashio::config 'log_level')"

# Convert boolean to string explicitly
if bashio::config.true 'mcp_auth_enabled'; then
    export MCP_AUTH_ENABLED="true"
    bashio::log.info "MCP Authentication: ENABLED"
    if [[ -n "${MCP_AUTH_TOKEN}" ]]; then
        bashio::log.info "Using configured MCP auth token"
    else
        bashio::log.info "No token configured - will auto-generate"
    fi
else
    export MCP_AUTH_ENABLED="false"
    bashio::log.warning "MCP Authentication: DISABLED - Anyone can access the MCP endpoint"
fi

bashio::log.info "Connecting to Homebox at: ${HOMEBOX_URL}"
bashio::log.debug "MCP_AUTH_ENABLED=${MCP_AUTH_ENABLED}"

# Run the MCP server
exec python3 /app/server.py
